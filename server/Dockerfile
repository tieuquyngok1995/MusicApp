# ===============================
# üê≥ Dockerfile: lesson-server
# ===============================
FROM node:20-bullseye

# T·∫°o th∆∞ m·ª•c l√†m vi·ªác
WORKDIR /app

# Copy v√† c√†i dependencies
COPY package*.json ./
RUN npm install --production

# Copy to√†n b·ªô source code
COPY . .

# C√†i cron
RUN apt-get update && apt-get install -y cron

# T·∫°o file cron ƒë·ªÉ ch·∫°y m·ªói gi·ªù
RUN echo "0 * * * * cd /app && npm run build-lessons >> /var/log/cron.log 2>&1" > /etc/cron.d/lesson-cron

# Set quy·ªÅn th·ª±c thi cho cron job
RUN chmod 0644 /etc/cron.d/lesson-cron

# Apply cron job
RUN crontab /etc/cron.d/lesson-cron

# T·∫°o file log
RUN touch /var/log/cron.log

# M·ªü port cho API
EXPOSE 9891

# Ch·∫°y c·∫£ cron v√† Node server song song
CMD cron && npm start
